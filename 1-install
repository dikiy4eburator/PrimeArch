#!/bin/sh

clear
echo "#################################################"
echo " Wilkommen beim Arch EFI installations skript"
echo "#################################################"
echo
echo "Bitte beantworten Sie einige Fragen zu der Systemconfiguration"
echo
#echo "Welchen kontrroler benutzt ihre Festplatte? (nvme oder sata): "
#read -p ">> " HDCONTROLER
echo "Mochten Sie eine extra HOME Partition haben? (ja/nein)"
read -p ">> " EXTRAHOME
echo
echo
lsblk
echo
echo
echo "Welche Festplatte soll für die Installation benutzt werden? (z.B. sda, nvme0n1 etc.) "
read -p ">> " HDD
echo
echo "Im folgenden wird das Programm Cgpartet gestartet"
echo "Bitte erstellen Die die Partitione in der folgenden Ordnung:"
echo "  1. EFI ca. 100-256 Mb ( code: ef00 )"
echo "  2. SWAP Gröse nach eigenem Ermessen ( code: 8200 )"
echo
echo "     Wenn Sie keine extra HOME Partition wollen"
echo "     Könne Sie den restlichen Speicher der ROOT Partition zweisen"
echo "     Ansonsten: "
echo
echo "  3. ROOT ca. 20-40 Gb ( code: 8300 )"
echo "  4. HOME rest des Speichers ( code: 8300 )"
echo
echo
read -p "Drücken Sie Enter zum fortfahren"

cgdisk /dev/$HDD

case $EXTRAHOME in
  ja)
  case $HDD in
    nvme*)
      BOOT_HD="${HDD}p1"
      SWAP_HD="${HDD}p2"
      ROOT_HD="${HDD}p3"
      HOME_HD="${HDD}p4"

      # formating partitions
      mkfs.fat -F32 /dev/$BOOT_HD
      mkswap /dev/$SWAP_HD
      mkfs.ext4 /dev/$ROOT_HD
      mkfs.ext4 /dev/$HOME_HD

      # Mounting partitions
      mount -o defaults,noatime,discard /dev/$ROOT_HD /mnt
      mkdir /mnt/boot
      mkdir /mnt/boot/efi
      mount /dev/$BOOT_HD /mnt/boot/efi
      mkdir /mnt/home
      mount -o defaults,noatime,discard /dev/$HOME_HD /mnt/home
      swapon /dev/$SWAP_HD
      break
      ;;

    sd*)
      BOOT_HD="${HDD}1"
      SWAP_HD="${HDD}2"
      ROOT_HD="${HDD}3"
      HOME_HD="${HDD}4"

      # formating partitions
      mkfs.fat -F32 /dev/$BOOT_HD
      mkswap /dev/$SWAP_HD
      mkfs.ext4 /dev/$ROOT_HD
      mkfs.ext4 /dev/$HOME_HD

      # Mounting partitions
      mount -o defaults,noatime,discard /dev/$ROOT_HD /mnt
      mkdir /mnt/boot
      mkdir /mnt/boot/efi
      mount /dev/$BOOT_HD /mnt/boot/efi
      mkdir /mnt/home
      mount -o defaults,noatime,discard /dev/$HOME_HD /mnt/home
      swapon /dev/$SWAP_HD
      break
      ;;

    break

    *)
      echo "HDD eingabe unbekant"
      exit
      ;;
  esac

  nein)
  case $HDD in
    nvme*)
      BOOT_HD="${HDD}p1"
      SWAP_HD="${HDD}p2"
      ROOT_HD="${HDD}p3"

      # formating partitions
      mkfs.fat -F32 /dev/$BOOT_HD
      mkswap /dev/$SWAP_HD
      mkfs.ext4 /dev/$ROOT_HD

      # Mounting partitions
      mount -o defaults,noatime,discard /dev/$ROOT_HD /mnt
      mkdir /mnt/boot
      mkdir /mnt/boot/efi
      mount /dev/$BOOT_HD /mnt/boot/efi
      swapon /dev/$SWAP_HD
      break
      ;;

    sd*)
      BOOT_HD="${HDD}1"
      SWAP_HD="${HDD}2"
      ROOT_HD="${HDD}3"

      # formating partitions
      mkfs.fat -F32 /dev/$BOOT_HD
      mkswap /dev/$SWAP_HD
      mkfs.ext4 /dev/$ROOT_HD

      # Mounting partitions
      mount -o defaults,noatime,discard /dev/$ROOT_HD /mnt
      mkdir /mnt/boot
      mkdir /mnt/boot/efi
      mount /dev/$BOOT_HD /mnt/boot/efi
      swapon /dev/$SWAP_HD
      break
      ;;

    break

    *)
      echo "HDD eingabe unbekant"
      exit
      ;;
  esac

  *)
  echo "EXTRAHOME eingabe unbekant"
  exit
  ;;

esac

# Install base pacages
pacstrap -i /mnt base base-devel linux-headers grub os-prober efibootmgr acpid dbus fish

# Generate fstab
genfstab -U -p /mnt >> /mnt/etc/fstab

curl -o /mnt/home/2 https://raw.githubusercontent.com/dikiy4eburator/arch-helpers/master/2-config
curl -o /mnt/home/3 https://raw.githubusercontent.com/dikiy4eburator/arch-helpers/master/3-gui-conf

arch-chroot /mnt

exit
