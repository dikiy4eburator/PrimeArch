#!/bin/sh
loadkeys de

# includes
source /root/lib/user_handeler
source /root/lib/gen_hdd_menu

source /root/lib/autopartition
source /root/lib/define_hdd_patern
source /root/lib/format_mount

# //////////////////////////////////////////////////////////////////////////////
# //////////////////    VARIABELS DEFINITION  ///////////////////////////////////
# //////////////////////////////////////////////////////////////////////////////

# set Variabels
BoxWhith=75
BoxStartX=2
BoxStartY=2


# //////////////////////////////////////////////////////////////////////////////
# //////////////////    FUNKTION DEFINITION  ///////////////////////////////////
# //////////////////////////////////////////////////////////////////////////////


# arch-chroot Bridge
# Adapted from AIS. An excellent bit of code!
function f_arch_chroot() {
    arch-chroot /mnt /bin/bash -c "${1}"
}



# //////////////////////////////////////////////////////////////////////////////
# //////////////////    START INSTALATION   ////////////////////////////////////
# //////////////////////////////////////////////////////////////////////////////


# Welkom Screan
dialog \
  --backtitle 'PrimeArch Installer' \
  --title 'Wilkommen' \
  --begin $BoxStartY $BoxStartX \
  --msgbox '

Bitte beantworten Sie einige Fragen zu der Systemconfiguration' 10 $BoxWhith


# Extra Home partition Screan
dialog \
  --backtitle 'PrimeArch Installer' \
  --title 'Extra HOME Partition' \
  --begin $BoxStartY $BoxStartX \
  --yesno '

Mochten Sie eine extra HOME Partition haben?' 10 $BoxWhith \

if [[ $? -eq 0 ]];
  then
    echo "ja" > /tmp/extrahome

    # Set root_size
    dialog \
      --backtitle 'PrimeArch Installer' \
      --begin $BoxStartY $BoxStartX \
      --inputbox 'Bitte ROOT Partitionsgröse angeben (GB)' 10 $BoxWhith \
      2>/tmp/root_size

  else
    echo "nein" > /tmp/extrahome
fi

f_gen_hdd_menu
sh /tmp/hdd_menu


# Partitionierung AUTO MANUEL
dialog \
  --backtitle 'PrimeArch Installer' \
  --title 'Partitionierung' \
  --begin $BoxStartY $BoxStartX \
  --yesno '

Mochten Sie eine automatiche Partitionierung durchführen?' 10 $BoxWhith \

if [[ $? -eq 0 ]];
  then
    # Set swap_size
    dialog \
      --backtitle 'PrimeArch Installer' \
      --begin $BoxStartY $BoxStartX \
      --inputbox 'Bitte SWAP Partitionsgröse angeben (GB)' 10 $BoxWhith \
      2>/tmp/swap_size

  f_autopartition

  else
    # Show Partitioning info depending on boot mode
    if [[ -d "/sys/firmware/efi/efivars" ]];
      then
        dialog \
          --backtitle 'PrimeArch Installer' \
          --title 'Partitions Tabelle' \
          --begin $BoxStartY $BoxStartX \
          --msgbox '

    Im folgenden wird das Programm cgdisk gestartet
    Bitte erstellen Sie die Partitione in der folgenden Ordnung:

    1. EFI ca. 100-256 Mb ( code: ef00 )"
    2. SWAP Gröse nach eigenem Ermessen ca. 4-8 Gb ( code: 8200 )

        Wenn Sie keine extra HOME Partition wollen"
        Könne Sie den restlichen Speicher der ROOT Partition zweisen

    Ansonsten:
    3. ROOT ca. 20-40 Gb ( code: 8300 )
    4. HOME rest des Speichers ( code: 8300 )' 20 $BoxWhith


      else
        dialog \
          --backtitle 'PrimeArch Installer' \
          --title 'Partitions Tabelle' \
          --begin $BoxStartY $BoxStartX \
          --msgbox '

    Im folgenden wird das Programm cgdisk gestartet
    Bitte erstellen Sie die Partitione in der folgenden Ordnung:

    1. BOOT ca. 5 Mb ( code: ef02)"
    2. SWAP Gröse nach eigenem Ermessen ca. 4-8 Gb ( code: 8200 )

        Wenn Sie keine extra HOME Partition wollen"
        Könne Sie den restlichen Speicher der ROOT Partition zweisen

    Ansonsten:
    3. ROOT ca. 20-40 Gb ( code: 8300 )
    4. HOME rest des Speichers ( code: 8300 )' 20 $BoxWhith

    fi
    # Start cgdisk
    cgdisk /dev/$(</tmp/hdd_name)

fi


# Start HDD preparation
case $(</tmp/hdd_name) in
  nvme*)
    f_def_hdd_patern_nvme
    ;;
  sd*)
    f_def_hdd_patern_sata
esac

# Format Partition
f_format

# Mount Partition
f_mount



# Install base pacages
pacstrap /mnt base fish base-devel linux-headers grub os-prober efibootmgr acpid dbus  vim cronie xdg-user-dirs

# Generate fstab
genfstab -U -p /mnt >> /mnt/etc/fstab



# Grafiktreiber installation
dialog \
  --backtitle "PrimeArch" \
  --begin $BoxStartY $BoxStartX \
  --menu "Grafiktreiber wehlen" 15 $BoxWhith 7 \
        1 virtualbox \
        2 Nvidia \
        3 ATI \
        4 Intel \
        5 Nouveau \
        0 'Keine Videotreiber' \
        2>/tmp/grafik_treiber

case $(</tmp/grafik_treiber) in
  1 )
    pacstrap /mnt virtualbox-guest-dkms virtualbox-guest-utils
    ;;
  2 )
    pacstrap /mnt nvidia
    ;;
  3 )
    pacstrap /mnt xf86-video-ati
    ;;
  4 )
    pacstrap /mnt xf86-video-intel
    ;;
  5 )
    pacstrap /mnt xf86-video-nouveau
    ;;
  0)
    break
    ;;
esac



# GUI installation
dialog \
  --backtitle "PrimeArch Installer" \
  --begin $BoxStartY $BoxStartX \
  --menu "Desktop wehlen" 15 $BoxWhith 8 \
        1 i3 \
        2 Xfce \
        3 Mate \
        4 KDE-Plasma \
        5 Gnome \
        6 Deepin \
        0 'Keinen Desktop' \
        2>/tmp/gui


case $(</tmp/gui) in
  1 )
    pacstrap /mnt i3 dmenu
    ;;
  2 )
    pacstrap /mnt xfce4 xfce4-goodies
    ;;
  3 )
    pacstrap /mnt mate mate-extra
    ;;
  4 )
    pacstrap /mnt plasma
    ;;
  5)
    pacstrap /mnt gnome gnome-extra
    ;;
  6)
    pacstrap /mnt deepin deepin-extra
    ;;
  0)
    break
    ;;
esac



#Install Login managment
pacstrap /mnt lightdm lightdm-gtk-greeter

#Install Network pakages
pacstrap /mnt avahi networkmanager network-manager-applet nm-connection-editor ntp wireless_tools wpa_supplicant gnome-keyring nfs-utils openssh

#Install Audio pakages
pacstrap /mnt alsa-tools alsa-utils pulseaudio pulseaudio-alsa pavucontrol flac volumeicon audacious

#Install Video pakages
pacstrap /mnt xorg-server xorg-xinit compton ffmpeg vlc mpv

#Install Additional apps
pacstrap /mnt ranger git htop nitrogen terminology rsync cool-retro-term
pacstrap /mnt chromium atom conky dunst hunspell-de

#Mate pakages
pacstrap /mnt mate-polkit pluma caja caja-open-terminal caja-sendto caja-share caja-wallpaper engrampa

#Install Themes
pacstrap /mnt lxappearance-gtk3 arc-gtk-theme arc-icon-theme archlinux-wallpaper

#Install fonts
pacstrap /mnt gnome-font-viewer awesome-terminal-fonts ttf-ubuntu-font-family



# Set hostname
dialog \
  --backtitle 'PrimeArch Installer' \
  --begin $BoxStartY $BoxStartX \
  --inputbox 'Bitte Hostnamen eingeben' 10 $BoxWhith \
  2>/mnt/etc/hostname



#Set ROOT PW
f_set_root



# CREATE NEW USER
dialog \
  --backtitle 'PrimeArch Installer' \
  --title 'Neuen Benutzer erstellen?' \
  --begin $BoxStartY $BoxStartX \
  --yesno 'Möchten sie einen neuen Benutzer erstellen?' 10 $BoxWhith \

if [[ $? -eq 0 ]]; # IF YES !!!
  then
    dialog \
      --backtitle 'PrimeArch Installer' \
      --begin $BoxStartY $BoxStartX \
      --inputbox 'Bitte Benutzernamen eingeben' 10 $BoxWhith \
      2>/tmp/user_name

      arch-chroot /mnt /bin/bash -c "useradd -m -g users -G wheel,storage,power,network,video,audio -s /usr/bin/fish '$(</tmp/user_name)'"

      #Set USER PW
      f_set_user

      echo "%wheel ALL=(ALL) ALL" >> /mnt/etc/sudoers
  else
    break
fi



# /etc/locale.conf
f_arch_chroot "echo LANG=de_DE.UTF-8 > /etc/locale.conf"
f_arch_chroot "echo LANGUAGE=de_DE >> /etc/locale.conf"

# /etc/vconsole.conf
f_arch_chroot "echo KEYMAP=de-latin1-nodeadkeys > /etc/vconsole.conf"

# Set Time
f_arch_chroot "rm /etc/localtime"
f_arch_chroot "ln -sf /usr/share/zoneinfo/Europe/Berlin /etc/localtime"

# /etc/locale.gen
f_arch_chroot "echo de_DE.UTF-8 UTF-8 >> /etc/locale.gen"
arch-chroot /mnt /bin/bash -c locale-gen



#GRUB INSTALLATION
if [[ -d "/sys/firmware/efi/efivars" ]];
then
  # install grub efi
  f_arch_chroot "grub-install --efi-directory=/boot/efi --bootloader-id=Arch_$(</mnt/etc/hostname)"
else
  # install grub legacy
  f_arch_chroot "grub-install /dev/$(</tmp/hdd_name)"
fi

f_arch_chroot "grub-mkconfig -o /boot/grub/grub.cfg"



#start system daemons
f_arch_chroot "systemctl enable acpid"
f_arch_chroot "systemctl enable ntpd"
# network managment
f_arch_chroot "systemctl enable avahi-daemon"
f_arch_chroot "systemctl enable wpa_supplicant"
f_arch_chroot "systemctl enable NetworkManager"
# NFS utils
f_arch_chroot "systemctl enable rpcbind"
# Cronie
f_arch_chroot "systemctl enable cronie.service"
#lightdm
f_arch_chroot "systemctl enable lightdm.service"



# Clone i3-config repo
if [[ -f /mnt/bin/i3 ]]; then
  git clone https://github.com/dikiy4eburator/i3-config.git /mnt/home/$(</tmp/user_name)/.config/i3
else
  break
fi

# link gtk-theme config
cp -r /root/lib/gtk-3.0 /mnt/home/$(</tmp/user_name)/.config

# link gtk-theme config
cp -r /root/lib/fish /mnt/home/$(</tmp/user_name)/.config

# Nitrogen config
cp -r /root/lib/nitrogen /mnt/home/$(</tmp/user_name)/.config

# dunst config
cp -r /root/lib/dunst /mnt/home/$(</tmp/user_name)/.config

#keyboard Conf
cp -r /root/lib/xorg.conf.d /mnt/etc/X11

# Copy Addons script
mv  /root/lib/Addons /mnt/home/$(</tmp/user_name)/Addons

# link usb automount rule
mv /root/lib/UDEV-automount-usb/10-my-media-automount.rules /mnt/etc/udev/rules.d/10-my-media-automount.rules


arch-chroot /mnt /bin/bash -c "sudo -u $(</tmp/user_name) sh /home/$(</tmp/user_name)/Addons"


arch-chroot /mnt /bin/bash -c "chown -R $(</tmp/user_name):users /home/$(</tmp/user_name)"
arch-chroot /mnt /bin/bash -c "chmod -R 0700 /home/$(</tmp/user_name)"



##Selekt HDD screan
dialog \
	--backtitle 'PrimeArch Installer' \
	--title 'Ende erreicht' \
	--begin $BoxStartY $BoxStartX \
	--menu "installation Beendet" 15 $BoxWhith 8 \
		    1 Rebooten \
        2 Ausschalten \
        3 Chroot \
        2>/tmp/exit

case $(</tmp/exit) in
  1 )
    reboot
    ;;
  2 )
    poweroff
    ;;
  3 )
    arch-chroot /mnt
    ;;
esac

exit
