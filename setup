#!/bin/sh

# includes
source /root/PrimeArch/lib/user_ops
source /root/PrimeArch/lib/hard_drive_ops

# //////////////////////////////////////////////////////////////////////////////
# //////////////////    VARIABELS DEFINITION  //////////////
# //////////////////////////////////////////////////////////////////////////////

# set Variabels
BoxWhith=70
consol_X=$(tput cols)
consol_Y=$(tput lines)
BoxStartX=$(( ($consol_X - $BoxWhith)/2  ))
BoxStartY=3

# //////////////////////////////////////////////////////////////////////////////
# //////////////////    FUNKTION DEFINITION  ///////////////
# //////////////////////////////////////////////////////////////////////////////

# arch-chroot Bridge
# Adapted from AIS. An excellent bit of code!
function f_arch_chroot() {
    arch-chroot /mnt /bin/bash -c "${1}"
}

# //////////////////////////////////////////////////////////////////////////////
# //////////////////    START INSTALATION   ///////////////////
# //////////////////////////////////////////////////////////////////////////////


# Welkom Screan
#--------------------------------------------------------------------------------------------------------------------------------------
dialog \
--backtitle 'PrimeArch Installer' \
--title 'Wilkommen beim PrimeArch Installer' \
--begin $BoxStartY $BoxStartX \
--msgbox '\n Last den Spass beginnen' 7 $BoxWhith
#--------------------------------------------------------------------------------------------------------------------------------------





# Partitionierung AUTO MANUEL
#--------------------------------------------------------------------------------------------------------------------------------------
dialog \
--backtitle 'PrimeArch Installer' \
--title 'Partitionierung' \
--begin $BoxStartY $BoxStartX \
--yesno '\n Mochten Sie eine automatiche Partitionierung durchf√ºhren? \n' 7 $BoxWhith \

if [[ $? -eq 0 ]];
	then
    		f_autopartition
	else
        	f_man_part
fi
#--------------------------------------------------------------------------------------------------------------------------------------





# Install base pacages
#--------------------------------------------------------------------------------------------------------------------------------------
pacstrap /mnt $(</root/lib/pacages)
#--------------------------------------------------------------------------------------------------------------------------------------





# Generate fstab
#--------------------------------------------------------------------------------------------------------------------------------------
genfstab -U -p /mnt > /mnt/etc/fstab
#--------------------------------------------------------------------------------------------------------------------------------------





# Grafiktreiber installation
#--------------------------------------------------------------------------------------------------------------------------------------
dialog \
--backtitle "PrimeArch" \
--begin $BoxStartY $BoxStartX \
--menu "Grafiktreiber wehlen" 15 $BoxWhith 6 \
1 virtualbox \
2 Nvidia \
3 ATI \
4 Intel \
5 Nouveau \
0 'Keine Videotreiber' \
2>/tmp/grafik_treiber

case $(</tmp/grafik_treiber) in

	1 )
        	pacstrap /mnt virtualbox-guest-dkms virtualbox-guest-utils ;;
    	2 )
        	pacstrap /mnt nvidia ;;
    	3 )
        	pacstrap /mnt xf86-video-ati ;;
    	4 )
        	pacstrap /mnt xf86-video-intel ;;
    	5 )
        	pacstrap /mnt xf86-video-nouveau ;;
    	0 )
        	break ;;
esac
#--------------------------------------------------------------------------------------------------------------------------------------





# Set hostname
#--------------------------------------------------------------------------------------------------------------------------------------
dialog \
--backtitle 'PrimeArch Installer' \
--begin $BoxStartY $BoxStartX \
--inputbox 'Bitte Hostnamen eingeben' 8 $BoxWhith \
2>/mnt/etc/hostname
#--------------------------------------------------------------------------------------------------------------------------------------





#Set ROOT PW
#--------------------------------------------------------------------------------------------------------------------------------------
f_root_pw_dialog
#--------------------------------------------------------------------------------------------------------------------------------------





# CREATE NEW USER
#--------------------------------------------------------------------------------------------------------------------------------------
f_create_new_user
#--------------------------------------------------------------------------------------------------------------------------------------





#GENERATE SYSTEM LOCALE
#--------------------------------------------------------------------------------------------------------------------------------------
# /etc/locale.conf
echo LANG=de_DE.UTF-8 >> /mnt/etc/locale.conf
echo LANGUAGE=de_DE >> /mnt/etc/locale.conf

# /etc/vconsole.conf
echo KEYMAP=de-latin1-nodeadkeys > /mnt/etc/vconsole.conf

# Set Time
rm /mnt/etc/localtime
arch-chroot /mnt /bin/bash -c 'ln -s /usr/share/zoneinfo/Europe/Berlin /etc/localtime'

# /etc/locale.gen
echo de_DE.UTF-8 UTF-8 >> /mnt/etc/locale.gen

arch-chroot /mnt /bin/bash -c locale-gen
#--------------------------------------------------------------------------------------------------------------------------------------





# COPY CONFIG FILES
#--------------------------------------------------------------------------------------------------------------------------------------

# USER FILES

# Clone i3-config
git clone https://github.com/dikiy4eburator/i3-config.git /mnt/home/$(</tmp/user_name)/.config/i3

# gtk-theme config
cp -r /root/PrimeArch/lib/gtk-3.0 /mnt/home/$(</tmp/user_name)/.config

# fish config
cp -r /root/PrimeArch/lib/fish /mnt/home/$(</tmp/user_name)/.config

# Nitrogen config
cp -r /root/PrimeArch/lib/nitrogen /mnt/home/$(</tmp/user_name)/.config

# dunst config
cp -r /root/PrimeArch/lib/dunst /mnt/home/$(</tmp/user_name)/.config

# Terminator config
cp -r /root/PrimeArch/lib/terminator /mnt/home/$(</tmp/user_name)/.config

# Rofi config
cp -r /root/PrimeArch/lib/rofi /mnt/home/$(</tmp/user_name)/.config



#SYSTEM FILES

#keyboard Conf
cp -r /root/PrimeArch/lib/xorg.conf.d /mnt/etc/X11

#keyboard Conf
mv -f /root/PrimeArch/lib/lightdm-config/lightdm-gtk-greeter.conf /mnt/etc/lightdm/lightdm-gtk-greeter.conf


#--------------------------------------------------------------------------------------------------------------------------------------





# INSTALL COSMETIC ADONS
#--------------------------------------------------------------------------------------------------------------------------------------
mv  /root/PrimeArch/lib/Addons /mnt/home/$(</tmp/user_name)/Addons
arch-chroot /mnt /bin/bash -c "sudo -u $(</tmp/user_name) sh /home/$(</tmp/user_name)/Addons"
rm /mnt/home/$(</tmp/user_name)/Addons
#--------------------------------------------------------------------------------------------------------------------------------------





# FIX USER HOME OWNERSHIP
#--------------------------------------------------------------------------------------------------------------------------------------
arch-chroot /mnt /bin/bash -c "chown -R $(</tmp/user_name):users /home/$(</tmp/user_name)"
arch-chroot /mnt /bin/bash -c "chmod -R 0700 /home/$(</tmp/user_name)"
#--------------------------------------------------------------------------------------------------------------------------------------





#GRUB INSTALLATION
#--------------------------------------------------------------------------------------------------------------------------------------
if [[ -d "/sys/firmware/efi/efivars" ]];
    	then
       		# install grub efi
       		f_arch_chroot "grub-install --efi-directory=/boot/efi --bootloader-id=Arch_$(</mnt/etc/hostname)"
    	else
      		# install grub legacy
      		f_arch_chroot "grub-install /dev/$(</tmp/hdd_name)"
fi

f_arch_chroot "grub-mkconfig -o /boot/grub/grub.cfg"
#--------------------------------------------------------------------------------------------------------------------------------------




# START DAEMONS
#--------------------------------------------------------------------------------------------------------------------------------------
#start system daemons
f_arch_chroot "systemctl enable acpid"
f_arch_chroot "systemctl enable ntpd"

# network managment
f_arch_chroot "systemctl enable avahi-daemon"
f_arch_chroot "systemctl enable wpa_supplicant"
f_arch_chroot "systemctl enable NetworkManager"

# NFS utils
f_arch_chroot "systemctl enable rpcbind"

# Cronie
f_arch_chroot "systemctl enable cronie.service"

#lightdm
f_arch_chroot "systemctl enable lightdm.service"
#--------------------------------------------------------------------------------------------------------------------------------------





##Selekt HDD screan
#--------------------------------------------------------------------------------------------------------------------------------------
dialog \
--backtitle 'PrimeArch Installer' \
--title 'Ende erreicht' \
--begin $BoxStartY $BoxStartX \
--menu "" 9 $BoxWhith 3 \
1 Rebooten \
2 Ausschalten \
3 Chroot \
2>/tmp/exit

case $(</tmp/exit) in
    	1 )
		umount -a
        	reboot ;;
    	2 )
		umount -a
        	poweroff ;;
    	3 )
        	arch-chroot /mnt ;;
esac
#--------------------------------------------------------------------------------------------------------------------------------------





exit
