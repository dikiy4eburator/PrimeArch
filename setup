#!/bin/sh

# includes
source /root/lib/user_ops
source /root/lib/hard_drive_ops

# //////////////////////////////////////////////////////////////////////////////
# //////////////////    VARIABELS DEFINITION  //////////////
# //////////////////////////////////////////////////////////////////////////////

# set Variabels
BoxWhith=70
consol_X=$(tput cols)
consol_Y=$(tput lines)
BoxStartX=$(( ($consol_X - $BoxWhith)/2  ))
BoxStartY=3

# //////////////////////////////////////////////////////////////////////////////
# //////////////////    FUNKTION DEFINITION  ///////////////
# //////////////////////////////////////////////////////////////////////////////

# arch-chroot Bridge
# Adapted from AIS. An excellent bit of code!
function f_arch_chroot() {
    arch-chroot /mnt /bin/bash -c "${1}"
}

# //////////////////////////////////////////////////////////////////////////////
# //////////////////    START INSTALATION   ///////////////////
# //////////////////////////////////////////////////////////////////////////////


# Welkom Screan
#--------------------------------------------------------------------------------------------------------------------------------------
dialog \
--backtitle 'PrimeArch Installer' \
--title 'Wilkommen beim PrimeArch Installer' \
--begin $BoxStartY $BoxStartX \
--msgbox '\n Last den Spass beginnen' 7 $BoxWhith
#--------------------------------------------------------------------------------------------------------------------------------------





#Generate HDD selektion menu
#--------------------------------------------------------------------------------------------------------------------------------------
f_gen_hdd_menu
sh /tmp/hdd_menu
#--------------------------------------------------------------------------------------------------------------------------------------





# Extra Home partition Screan
#--------------------------------------------------------------------------------------------------------------------------------------
dialog \
--backtitle 'PrimeArch Installer' \
--title 'Extra HOME Partition' \
--begin $BoxStartY $BoxStartX \
--yesno '\n Mochten Sie eine extra HOME Partition haben? \n' 7 $BoxWhith \

if [[ $? -eq 0 ]];
	then
        	echo "ja" > /tmp/extrahome

		dialog \
            	--backtitle 'PrimeArch Installer' \
             	--begin $BoxStartY $BoxStartX \
             	--inputbox '\n Bitte geben Sie die Gröse der ROOT Partition in GiB an. \n' 10 $BoxWhith \
             	2>/tmp/root_size
    	else
            	echo "nein" > /tmp/extrahome
fi
#--------------------------------------------------------------------------------------------------------------------------------------





# Partitionierung AUTO MANUEL
#--------------------------------------------------------------------------------------------------------------------------------------
dialog \
--backtitle 'PrimeArch Installer' \
--title 'Partitionierung' \
--begin $BoxStartY $BoxStartX \
--yesno '\n Mochten Sie eine automatiche Partitionierung durchführen? \n' 7 $BoxWhith \

if [[ $? -eq 0 ]];
	then
    		# Set swap_size
    		dialog \
    		--backtitle 'PrimeArch Installer' \
    		--begin $BoxStartY $BoxStartX \
    		--inputbox '\n Bitte geben Sie die Gröse der SWAP Partition in GiB an. \n' 10 $BoxWhith \
    		2>/tmp/swap_size

    		f_autopartition
	else
    		# Show Partitioning info depending on boot mode
    		if [[ -d "/sys/firmware/efi/efivars" ]];
        		then
          			dialog \
          			--backtitle 'PrimeArch Installer' \
          			--title 'Partitions Tabelle' \
          			--begin $BoxStartY $BoxStartX \
          			--msgbox '

          			Im folgenden wird das Programm cgdisk gestartet
          			Bitte erstellen Sie die Partitione in der folgenden Ordnung:

          			1. EFI ca. 100-256 Mb ( code: ef00 )
          			2. SWAP Gröse nach eigenem Ermessen ca. 4-8 Gb ( code: 8200 )

          			     Wenn Sie keine extra HOME Partition wollen
           			     Könne Sie den restlichen Speicher der ROOT Partition zweisen

          			Ansonsten:
          			3. ROOT ca. 20-40 Gb ( code: 8300 )
          			4. HOME rest des Speichers ( code: 8300 ) ' 20 $BoxWhith

        		else
          			dialog \
          			--backtitle 'PrimeArch Installer' \
          			--title 'Partitions Tabelle' \
          			--begin $BoxStartY $BoxStartX \
          			--msgbox '

          			Im folgenden wird das Programm cgdisk gestartet
          			Bitte erstellen Sie die Partitione in der folgenden Ordnung:

          			1. BOOT ca. 5 Mb ( code: ef02)
          			2. SWAP Gröse nach eigenem Ermessen ca. 4-8 Gb ( code: 8200 )

          			     Wenn Sie keine extra HOME Partition wollen
          			     Könne Sie den restlichen Speicher der ROOT Partition zweisen

          			Ansonsten:
          			3. ROOT ca. 20-40 Gb ( code: 8300 )
          			4. HOME rest des Speichers ( code: 8300 )' 20 $BoxWhith
        	fi

		# Start cgdisk
    		cgdisk /dev/$(</tmp/hdd_name)
fi
#--------------------------------------------------------------------------------------------------------------------------------------





# Start HDD preparation
#--------------------------------------------------------------------------------------------------------------------------------------
case $(</tmp/hdd_name) in
	nvme*)
        	f_def_hdd_patern_nvme ;;
	sd*)
        	f_def_hdd_patern_sata ;;
esac

# Format Partition
f_format

# Mount Partition
f_mount
#--------------------------------------------------------------------------------------------------------------------------------------





# Install base pacages
#--------------------------------------------------------------------------------------------------------------------------------------
pacstrap /mnt $(</root/lib/pacages)
#--------------------------------------------------------------------------------------------------------------------------------------





# Generate fstab
#--------------------------------------------------------------------------------------------------------------------------------------
genfstab -U -p /mnt > /mnt/etc/fstab
#--------------------------------------------------------------------------------------------------------------------------------------





# Grafiktreiber installation
#--------------------------------------------------------------------------------------------------------------------------------------
dialog \
--backtitle "PrimeArch" \
--begin $BoxStartY $BoxStartX \
--menu "Grafiktreiber wehlen" 15 $BoxWhith 6 \
1 virtualbox \
2 Nvidia \
3 ATI \
4 Intel \
5 Nouveau \
0 'Keine Videotreiber' \
2>/tmp/grafik_treiber

case $(</tmp/grafik_treiber) in

	1 )
        	pacstrap /mnt virtualbox-guest-dkms virtualbox-guest-utils ;;
    	2 )
        	pacstrap /mnt nvidia ;;
    	3 )
        	pacstrap /mnt xf86-video-ati ;;
    	4 )
        	pacstrap /mnt xf86-video-intel ;;
    	5 )
        	pacstrap /mnt xf86-video-nouveau ;;
    	0 )
        	break ;;
esac
#--------------------------------------------------------------------------------------------------------------------------------------





# Set hostname
#--------------------------------------------------------------------------------------------------------------------------------------
dialog \
--backtitle 'PrimeArch Installer' \
--begin $BoxStartY $BoxStartX \
--inputbox 'Bitte Hostnamen eingeben' 8 $BoxWhith \
2>/mnt/etc/hostname
#--------------------------------------------------------------------------------------------------------------------------------------





#Set ROOT PW
#--------------------------------------------------------------------------------------------------------------------------------------
f_root_pw_dialog
#--------------------------------------------------------------------------------------------------------------------------------------





# CREATE NEW USER
#--------------------------------------------------------------------------------------------------------------------------------------
dialog \
--backtitle 'PrimeArch Installer' \
--title 'Neuen Benutzer erstellen?' \
--begin $BoxStartY $BoxStartX \
--yesno '\n Möchten sie einen neuen Benutzer erstellen? \n ' 7 $BoxWhith \

if [[ $? -eq 0 ]]; # IF YES !!!
    	then
       		dialog \
       		--backtitle 'PrimeArch Installer' \
       		--begin $BoxStartY $BoxStartX \
       		--inputbox 'Bitte Benutzernamen eingeben' 8 $BoxWhith \
       		2>/tmp/user_name

       		arch-chroot /mnt /bin/bash -c "useradd -m -g users -G wheel,storage,power,network,video,audio -s /usr/bin/fish '$(</tmp/user_name)'"

       		#Set USER PW
       		f_user_pw_dialog

       		echo "%wheel ALL=(ALL) ALL" >> /mnt/etc/sudoers
    	else
      		break
fi
#--------------------------------------------------------------------------------------------------------------------------------------





#GENERATE SYSTEM LOCALE
#--------------------------------------------------------------------------------------------------------------------------------------
# /etc/locale.conf
echo LANG=de_DE.UTF-8 >> /mnt/etc/locale.conf
echo LANGUAGE=de_DE >> /mnt/etc/locale.conf

# /etc/vconsole.conf
echo KEYMAP=de-latin1-nodeadkeys > /mnt/etc/vconsole.conf

# Set Time
rm /etc/localtime
ln -sf /mnt/usr/share/zoneinfo/Europe/Berlin /mnt/etc/localtime

# /etc/locale.gen
echo de_DE.UTF-8 UTF-8 >> /mnt/etc/locale.gen

arch-chroot /mnt /bin/bash -c locale-gen
#--------------------------------------------------------------------------------------------------------------------------------------





# COPY CONFIG FILES
#--------------------------------------------------------------------------------------------------------------------------------------

# Clone i3-config
git clone https://github.com/dikiy4eburator/i3-config.git /mnt/home/$(</tmp/user_name)/.config/i3

# gtk-theme config
cp -r /root/lib/gtk-3.0 /mnt/home/$(</tmp/user_name)/.config

# fish config
cp -r /root/lib/fish /mnt/home/$(</tmp/user_name)/.config

# Nitrogen config
cp -r /root/lib/nitrogen /mnt/home/$(</tmp/user_name)/.config

# dunst config
cp -r /root/lib/dunst /mnt/home/$(</tmp/user_name)/.config

# Terminator config
cp -r /root/lib/terminator /mnt/home/$(</tmp/user_name)/.config

# Terminator config
cp -r /root/lib/rofi /mnt/home/$(</tmp/user_name)/.config

#keyboard Conf
cp -r /root/lib/xorg.conf.d /mnt/etc/X11

#--------------------------------------------------------------------------------------------------------------------------------------





# INSTALL COSMETIC ADONS
#--------------------------------------------------------------------------------------------------------------------------------------
mv  /root/lib/Addons /mnt/home/$(</tmp/user_name)/Addons
arch-chroot /mnt /bin/bash -c "sudo -u $(</tmp/user_name) sh /home/$(</tmp/user_name)/Addons"
rm /mnt/home/$(</tmp/user_name)/Addons
#--------------------------------------------------------------------------------------------------------------------------------------





# FIX USER HOME OWNERSHIP
#--------------------------------------------------------------------------------------------------------------------------------------
arch-chroot /mnt /bin/bash -c "chown -R $(</tmp/user_name):users /home/$(</tmp/user_name)"
arch-chroot /mnt /bin/bash -c "chmod -R 0700 /home/$(</tmp/user_name)"
#--------------------------------------------------------------------------------------------------------------------------------------





#GRUB INSTALLATION
#--------------------------------------------------------------------------------------------------------------------------------------
if [[ -d "/sys/firmware/efi/efivars" ]];
    	then
       		# install grub efi
       		f_arch_chroot "grub-install --efi-directory=/boot/efi --bootloader-id=Arch_$(</mnt/etc/hostname)"
    	else
      		# install grub legacy
      		f_arch_chroot "grub-install /dev/$(</tmp/hdd_name)"
fi

f_arch_chroot "grub-mkconfig -o /boot/grub/grub.cfg"
#--------------------------------------------------------------------------------------------------------------------------------------




# START DAEMONS
#--------------------------------------------------------------------------------------------------------------------------------------
#start system daemons
f_arch_chroot "systemctl enable acpid"
f_arch_chroot "systemctl enable ntpd"

# network managment
f_arch_chroot "systemctl enable avahi-daemon"
f_arch_chroot "systemctl enable wpa_supplicant"
f_arch_chroot "systemctl enable NetworkManager"

# NFS utils
f_arch_chroot "systemctl enable rpcbind"

# Cronie
f_arch_chroot "systemctl enable cronie.service"

#lightdm
f_arch_chroot "systemctl enable lightdm.service"
#--------------------------------------------------------------------------------------------------------------------------------------





##Selekt HDD screan
#--------------------------------------------------------------------------------------------------------------------------------------
dialog \
--backtitle 'PrimeArch Installer' \
--title 'Ende erreicht' \
--begin $BoxStartY $BoxStartX \
--menu "" 9 $BoxWhith 3 \
1 Rebooten \
2 Ausschalten \
3 Chroot \
2>/tmp/exit

case $(</tmp/exit) in
    	1 )
        	reboot ;;
    	2 )
        	poweroff ;;
    	3 )
        	arch-chroot /mnt ;;
esac
#--------------------------------------------------------------------------------------------------------------------------------------





exit
